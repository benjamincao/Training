
DON'T REPEAT YOURSELF.
===================================================

### 1. 释义
DRY是软件开发中的一个基本的原则，主要目的是减少系统中各种知识的重复，尤其在分层系统中我们更需要坚持这一原则。DRY原则可以表述为：系统中的每一项知识，都 **必须** 具有单一、无歧义、权威的表示。

### 2. 重复的危害

#### 2.1 为什么重复会发生？
重复的发生是因为知识的变化——知识并不固定。    
作为程序员，我们收集、组织、维护和利用知识：我们在规范中记录知识，我们根据知识编写代码，我们的程序向使用人员传达我们的知识，我们的所有测试基于我们的知识。    
  
知识是在不断变化的：
* 需求改变
* 新的需求出现
* 商业逻辑改变——法律法规等的变化
* 编程使用技术的更新——语言、数据库、库等

#### 2.2 重复的危害
因为知识的变化，我们的软件需要不断的维护，从开发阶段到运行阶段直到这个软件死亡。当进行维护时，我们需要找到并改变代码中体现的“知识胶囊”。如果在开发的规范、过程和程序中出现重复的知识，那么我们就是在向维护的噩梦发出邀请，而这个噩梦甚至在应用发布之前就已经开始。   
我们在开发过程中，必须牢记，我要写出可靠的代码，我的代码易于理解和维护。


### 3. 重复的种类
#### 3.1 强加的重复(imposed)
程序员觉得无法选择，无法避免，各种环境要求重复。  

##### 3.1.1 信息的多种表示
在编码一级，尝尝需要以不同形式表现同一信息。例如如果我们在编写CS架构的程序，并且在C、S两端使用了不同的语言，并且需要在两端表示某种共有的结构，例如某个数据库表的schema。如果坚持DRY，这种情况我们应该如何处理呢？    

思考……   
思考……      
思考……   
思考……   
思考……   
思考……   

解决方法之一是使用公共的元数据表示需要构建的多种语言中的类结构，然后编写简单的过滤器或者代码生成器来自动生成类定义。  
其中的诀窍就是让该过程成为主动的，不同地方的代码一次性编写的，否则我们只能退回到重复数据的情况。    


##### 3.1.2 代码中的文档
通常我们接受的培训是：**程序需要注释，好的代码有许多注释**。但是，我们有没有想过：代码为什么需要注释？—— **糟糕的代码才需要许多注释**。    
DRY要求：把低级的知识放在代码中，它们属于那里（set the value to xxxx），把注释留给其它高级的说明。否则，我们就是在重复知识——知识存在于代码和注释中，每一次知识的更新都意味着要改变代码，也要改变注释。根据经验，代码将不可避免的过时。另外，请记住 **不可信任的注释比完全没有注释更糟糕**。  

##### 3.1.3 代码与文档
写文档，然后写代码；有些知识更新了，修订文档，更新代码，这导致文档和代码中包含了同一知识的表示。在最紧张的时候——deadline就在眼前，重要客户在不断催促——我们往往推迟文档的更新。   

如何解决？    

思考……   
思考……      
思考……   
思考……   
思考……   
思考……  

知识在一个地方保存，文档或者代码。然后根据代码生成文档，或者反过来，根据文档生成代码。    

##### 3.1.4 语言问题
语言在源码中强加客观的重复，例如模块接口与实现的分离，就经常会出现这样的情况。   
DRY原则：使用头文件记录接口，用实现文件记载代码的使用者无需了解的实际细节。   


#### 3.2 无意的重复(inadvertent)
程序员没有意识到他们在重复。  
看一个例子，配送行业。卡车有车型，车牌号，司机以及其他一些属性。发运路线的属性包括路线，卡车和司机。我们根据这个编写了一些类：Vehicles， DeliverRoute。    
想象一个场景，如果司机请假，需要更换司机，我们需要怎么处理呢？ Vehicle和DeliverRoute都需要更换司机属性，这也许表明，我们开始的认知是错误的，我们代码需要重构。

再看一个例子，一个线段类：Line

example1:

``` 

class Line {
    public $start;
    public $end;
    public $length;
}

```

length和start end重复。

example2:

``` 

class Line {
    public $start;
    public $end;
    public function length() {
        return len($start, $end);
    }
}

```

如果出于性能需要，假设计算长度的开销很大，我们并不想每次都计算长度——如果起始点没变化的话，那么我们应该怎么设计？    


思考……   
思考……      
思考……   
思考……   
思考……   
思考……  


example3：

```
class Line {
    private $start;
    private $end;
    
    private $length;

    private $changed;

    public function setStart($start) {
        $this->start = $start;
        $this->changed = true;
    }

    public function setEnd($end) {
        $this->end = $end;
        $this->changed = true;
    }

    public function getStart() {
        return $this->start;
    }

    public function getEnd() {
        return $this->end;
    }

    public function getLength() {
        if ($this->changed) {
            $this->length = len($start, $end);
            $this->changed = false;
        }

        return $this->length;
    }
}


```

出于性能要求，我们有时候会违背DRY原则，这通常发生在我们需要缓存数据，以避免昂贵的操作的时候。那么诀窍就是使影响局部化，不要将对DRY原则的违反暴露给外部，只有类的方法需要“保持行为良好”。

#### 3.3 无耐心的重复(impatient)
程序员偷懒，重复，是因为那样更简单。  
每个项目都有时间压力，这会驱使我们中最优秀的人走捷径，——以前写过的某个函数功能类似？拷贝过来做点改动就可以，不需要对原来的代码重构。在某个项目中已经写过对email的过滤规则？拷贝过来直接使用，虽然这里对email的长度要求做了一点改变。  
但是要记住一句古老的格言“欲速则不达”。  解决这个问题也很简单，接受必要的训练，并愿意为避免以后的痛苦而现在多花一点时间。   


#### 3.4 开发者之间的重复(interdeveloper)
同一团队的几个人重复了同样的信息。   
这是最难检测和处理的重复。甚至整个功能集都有可能被重新实现。  
要想有效避免这类重复，只能是程序员之间进行主动的交流。还可以将工具类实现为库，并单独维护。另外要阅读别人的代码，不管是在代码复查还是非正式形式的阅读。阅读别人的代码，不是窥探，是一种学习。每个人也要写出漂亮的代码，因为别人会钻研你的代码，别人会评判你的代码。   


### 4. 结论 
在写代码过程中，我们需要记住DRY，干燥的，干的，干。要记住知识会持续更新，你的代码需要不断的更新，也许几年之后，你可能还需要维护你自己的代码，几年后，当你维护自己代码的时候，能不脱口而出“shit”吗？

还想“Find All”吗？避免重复！